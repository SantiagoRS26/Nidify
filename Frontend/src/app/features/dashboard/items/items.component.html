<!-- Subheader -->
<header class="section-header glass subheader" role="region" aria-label="Ítems">
    <h2>Ítems</h2>
  
    <div class="actions desktop-only">
      <button class="btn btn-primary" type="button" (click)="openNew()">
        <!-- ícono + -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
        </svg>
        Nuevo ítem
      </button>
    </div>
  
    <!-- FAB móvil -->
    <button class="fab mobile-only" aria-label="Nuevo ítem" type="button" (click)="openNew()">＋</button>
    <span class="sr-only">Botón de acción flotante para crear un nuevo ítem</span>
  </header>
  
  <section class="items stack">
    <!-- Toolbar / búsqueda -->
    <div class="toolbar glass-card card-pad">
      <div class="input-group" style="width: 100%;">
        <span class="input-leading" aria-hidden="true">
          <!-- ícono buscar -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.5"/>
            <path d="m20 20-3.2-3.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </span>
        <input class="input input--with-leading" type="search" placeholder="Buscar ítems" />
      </div>
    </div>
  
    <!-- Filtros -->
    <div class="filters row">
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === 'all'"
        (click)="setFilter('all')"
      >
        Todos
      </button>
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === ItemType.ONE_TIME"
        (click)="setFilter(ItemType.ONE_TIME)"
      >
        Únicos
      </button>
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === ItemType.RECURRING"
        (click)="setFilter(ItemType.RECURRING)"
      >
        Recurrentes
      </button>
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === ItemPriority.NECESSARY"
        (click)="setFilter(ItemPriority.NECESSARY)"
      >
        Necesario
      </button>
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === ItemPriority.OPTIONAL"
        (click)="setFilter(ItemPriority.OPTIONAL)"
      >
        Opcional
      </button>
      <button
        class="chip chip--glass"
        type="button"
        [class.active]="activeFilter() === ItemPriority.WHIM"
        (click)="setFilter(ItemPriority.WHIM)"
      >
        Capricho
      </button>
    </div>
  
    <!-- Lista -->
    <div class="list responsive-grid">
      <article class="item glass-card" *ngFor="let item of filteredItems()">
        <header class="item__head">
          <div>
            <h3 class="item__title">{{ item.name }}</h3>
            <div class="item__meta">
              {{ categoryNameMap().get(item.categoryId || '') ?? '' }} • {{
                getStatusLabel(item.status)
              }}
            </div>
          </div>
          <div class="item__price">
            {{ item.price | currencyFormat }} {{ item.currency }}
          </div>
        </header>
  
        <footer class="item__footer">
          <div class="split" *ngIf="item.paymentSplit">
            <ng-container *ngFor="let a of item.paymentSplit.assignments; let last = last">
              {{ a.percentage | number: '1.0-2' }}% {{ a.label || a.userId }}
              ({{ a.calculatedAmount | currencyFormat }} {{ item.currency }})<span *ngIf="!last"> • </span>
            </ng-container>
          </div>
          <div class="tags">
            <span class="tag">{{ 'Prioridad: ' + getPriorityLabel(item.priority) }}</span>
            <button class="btn btn-ghost" type="button" (click)="edit(item)">Editar</button>
            <button class="btn btn-ghost" type="button" (click)="delete(item)">Eliminar</button>
          </div>
        </footer>
      </article>
    </div>
  </section>
  
  <!-- Modal -->
  <div class="modal" [class.open]="showNewItemModal()">
    <div class="backdrop" (click)="showNewItemModal.set(false)"></div>
  
    <div class="dialog glass card-pad" role="dialog" aria-modal="true"
         [attr.aria-label]="editingId() ? 'Editar ítem' : 'Nuevo ítem'">
      <div class="dialog__header">
        <h3>{{ editingId() ? 'Editar ítem' : 'Nuevo ítem' }}</h3>
        <button class="icon" type="button" (click)="showNewItemModal.set(false)" aria-label="Cerrar">✕</button>
      </div>
  
      <form class="dialog__body form-grid" [formGroup]="itemForm">
        <label>
          Nombre
          <input class="input" type="text" placeholder="Sillón" formControlName="name" />
        </label>
  
        <label>
          Categoría
          <select class="input" formControlName="categoryId">
            <option value="">Sin categoría</option>
            <option *ngFor="let cat of categories()" [value]="cat.id">{{ cat.name }}</option>
          </select>
        </label>
  
        <label>
          Tipo
          <select class="input" formControlName="type">
            <option *ngFor="let t of itemTypeOptions" [value]="t.value">{{ t.label }}</option>
          </select>
        </label>
  
        <label>
          Precio
          <input class="input" type="text" placeholder="0" formControlName="price" currencyInput />
        </label>
  
        <label>
          Moneda
          <select class="input" formControlName="currency">
            <option *ngFor="let c of currencies$ | async" [value]="c">{{ c }}</option>
          </select>
        </label>
  
        <label>
          Prioridad
          <select class="input" formControlName="priority">
            <option *ngFor="let p of itemPriorityOptions" [value]="p.value">{{ p.label }}</option>
          </select>
        </label>
  
        <label>
          Estado
          <select class="input" formControlName="status">
            <option *ngFor="let s of itemStatusOptions" [value]="s.value">{{ s.label }}</option>
          </select>
        </label>
  
        <label>
          Link de compra
          <input class="input" type="text" placeholder="https://..." formControlName="purchaseLink" />
        </label>
  
        <button class="btn btn-ghost" type="button" (click)="openSplit()">Dividir pago</button>
      </form>
  
      <div class="dialog__actions">
        <button class="btn btn-ghost" type="button" (click)="showNewItemModal.set(false)">Cancelar</button>
        <button class="btn btn-primary" type="button" (click)="save()">Guardar</button>
      </div>
    </div>
  </div>
  
  <app-split-modal
    *ngIf="showSplitModal()"
    [members]="members()"
    [total]="itemForm.get('price')?.value || 0"
    [initialSplit]="paymentSplit()"
    (cancel)="showSplitModal.set(false)"
    (save)="onSplitSave($event)">
  </app-split-modal>
  